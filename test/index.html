<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body style="display: none">
    <noscript>
      <p>This website requires JavaScript to function properly.</p>
    </noscript>

    <script>
      async function loadPage() {
        const token = "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";
        const repoOwner = "syrupstudios";
        const repoName = "PRIVATE";

        const params = new URLSearchParams(window.location.search);
        let folder = params.get("p") || "index";
        const htmlPath = `${folder}/index.html`;
        const cssPath = `${folder}/styles.css`;
        const jsFolderPath = `${folder}/JS/`;

        try {
          const folderCheckResponse = await fetch(
            `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${folder}`,
            { headers: { Authorization: `Bearer ${token}` } }
          );

          if (!folderCheckResponse.ok) {
            if (folderCheckResponse.status === 401) {
              throw new Error("401 Unauthorized: Authentication failed.");
            } else {
              console.warn(`Folder "${folder}" not found. Loading 404 page.`);
              folder = "404";
            }
          }

          const htmlResponse = await fetch(
            `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${folder}/index.html`,
            { headers: { Authorization: `Bearer ${token}` } }
          );

          if (!htmlResponse.ok) {
            if (htmlResponse.status === 401) {
              throw new Error("401 Unauthorized: Authentication failed.");
            } else {
              throw new Error("HTML file is required but could not be loaded.");
            }
          }

          const htmlData = await htmlResponse.json();
          const htmlContent = atob(htmlData.content);

          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlContent, "text/html");

          const cssPromise = fetch(
            `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${folder}/styles.css`,
            { headers: { Authorization: `Bearer ${token}` } }
          )
            .then(async (response) => {
              if (response.ok) {
                const cssData = await response.json();
                const cssContent = atob(cssData.content);
                const cssBlob = new Blob([cssContent], { type: "text/css" });
                const cssBlobURL = URL.createObjectURL(cssBlob);
                const cssLink = document.createElement("link");
                cssLink.rel = "stylesheet";
                cssLink.href = cssBlobURL;
                document.head.appendChild(cssLink);
              }
            })
            .catch(() => {
              console.warn(
                "CSS file not found or could not be loaded. Continuing..."
              );
            });

          const jsPromise = fetch(
            `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${folder}/JS/`,
            { headers: { Authorization: `Bearer ${token}` } }
          )
            .then(async (response) => {
              if (response.ok) {
                const jsFilesData = await response.json();
                for (const file of jsFilesData) {
                  if (file.type === "file" && file.name.endsWith(".js")) {
                    const jsFileResponse = await fetch(
                      `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${file.path}`,
                      { headers: { Authorization: `Bearer ${token}` } }
                    );

                    if (jsFileResponse.ok) {
                      const jsFileData = await jsFileResponse.json();
                      const jsContent = atob(jsFileData.content);
                      const jsBlob = new Blob([jsContent], {
                        type: "application/javascript",
                      });
                      const jsBlobURL = URL.createObjectURL(jsBlob);
                      const jsScript = document.createElement("script");
                      jsScript.src = jsBlobURL;
                      document.body.appendChild(jsScript);
                    }
                  }
                }
              }
            })
            .catch(() => {
              console.warn(
                "JS folder not found or could not be loaded. Continuing..."
              );
            });

          const newBody = doc.querySelector("body");
          newBody.style.display = "none";

          document.documentElement.innerHTML = doc.documentElement.innerHTML;

          await Promise.all([cssPromise, jsPromise]);
          const scripts = doc.querySelectorAll("script");
          scripts.forEach((script) => {
            const newScript = document.createElement("script");
            if (script.src) {
              newScript.src = script.src;
            } else {
              newScript.textContent = script.textContent;
            }
            document.body.appendChild(newScript);
          });
          document.body.style.removeProperty("display");
        } catch (error) {
          document.body.style.removeProperty("display");

          if (error.message.includes("401")) {
            document.body.innerHTML =
              "<h1>401 Unauthorized</h1><p>Authentication with server failed. Please check our status or refresh and try again.</p>";
            document.title = "Access Denied";
          } else {
            document.body.innerHTML =
              "<h1>Fatal Error</h1><p>An unknown error has occurred, please try to refresh to see if this happens again or contact support.</p>";
            document.title = "Fatal Error";
          }
          console.error("Error:", error);
        }
      }

      loadPage();
    </script>
  </body>
</html>
